#!/usr/bin/env bash
# Author
author="Philip Mello <@Microsoft>"
# Version
version="1.0"
# License
license="MIT"
# Date
current_date=$(date +'%b %d, %Y')
# GitHub
github='https://github.com/PhilipMello/kubernetes/'
github2='https://github.com/AtomyCloud/kubernetes'
# Microsoft Official Documentation
microsoft=''
echo "
# --------------------------------------------------------------
# Script     : Microsoft Azure AKS Script Automation
# Description: Create, Delete, Check, Fix. Azure AKS Cluster
# Version    : $version
# Date       : $current_date
# Author     : $author
# License    : $license
# Github     : $github
# Github     : $github2
# Microsoft  : $microsoft
# --------------------------------------------------------------
# How to use: Execute ./aks-tool
# Exemples:
# Manual: ./aks-tool -h OR ./aks-tool --h OR ./aks-tool --help
# --------------------------------------------------------------
"
WHITE=""
BLUE="\033[97;104m"
YELLOW="\033[97;103m"
CYAN="\033[97;106m"
MAGENTA="\033[97;45m"
GREEN="\033[97;102m"
RED="\033[97;41m"
ENDCOLOR="\e[0m"

function az_resource_group() {
    echo -e " Microsoft Official Documentation: 
    'https://learn.microsoft.com/en-us/cli/azure/group?view=azure-cli-latest'
    "
    echo "1. Create Resource Group"
    echo "2. Delete Resource Group"
    echo "3. Force Delete Resource Group"
    echo "4. Check if a Resource Group exists"
    read option
    case $option in
        1)
            echo "Create Resource Group"
            echo "Enter Resource Group Name:"
            read resource_group
            echo "To see locations run: az account list-locations -o table"
            echo "Enter Resource Group location:"
            read location
            echo "Enter tag name, or hit enter to no tag"
            read tags
            az group create --name $resource_group --location $location --tags $tags
            exit 110
            ;;
        2)
            echo "Delete Resource Group"
            echo "Enter Resource Group Name:"
            read resource_group
            az group delete --name $resource_group
            exit 120
            ;;
        3)
            echo "Force Delete Resource Group"
            echo "Enter Resource Group Name:"
            read resource_group
            az group delete --name $resource_group --force-deletion-types Microsoft.Compute/virtualMachines
            exit 130
            ;;
        4)
            echo "Check if a Resource Group exists"
            echo "Enter Resource Group Name:"
            read resource_group
            az group exists --name $resource_group
            if [ $? -eq 0 ]; then
                exit 140
            fi
            ;;
        *)
            echo "Invalid option"
            ;;
    esac
}

function aks_create() {
    # AKS Creation
    echo "1. Create AKS Default"
    echo "2. Create AKS with more options (Location, Node-Count, Network-Plugin, Tier, OS-SKU, VM-Size)"
    read option

    case $option in
    1)
        # Create AKS Default
        echo "Enter Resource Group Name:"
        read resource_group
        echo "Enter Cluster Name:"
        read cluster_name

        echo -e "
        +-------------------------------------------------------------------------+
        |${MAGENTA}AKS Creating${ENDCOLOR}
        +-------------------------------------------------------------------------+
        "  
        az aks create --resource-group $resource_group --name $cluster_name --node-count 1
        echo -e "
        +-------------------------------------------------------------------------+
        |${GREEN}AKS Created${ENDCOLOR}
        |Resource Group: $resource_group || Cluster Name: $cluster_name
        +-------------------------------------------------------------------------+
        "
        az aks get-credentials --resource-group $resource_group --name $cluster_name --overwrite-existing
        ;;
    2)
        # Create AKS cluster
        echo "Enter Resource Group Name:"
        read resource_group
        echo "Enter Cluster Name:"
        read cluster_name
        echo "Enter Location:{centralus, eastus, eastus2, swedencentral}"
        read location
        echo "Enter Node Count:{1, 2, 3,...}"
        read node_count
        echo "Enter Network Plugin:{azure, kubenet, none}"
        read network_plugin
        echo "Enter Tier:{free, premium, standard}"
        read tier
        echo "Enter OS SKU:{AzureLinux, CBLMariner, Mariner, Ubuntu}"
        read os_sku
        echo "Enter Node VM Size:{Standard_B2s, standard_ds2_v2}"
        read node_vm_size
        echo "Enter Managed Identity (MSI) OR Service Princiapl Name (SPN):{msi, spn}"
        read msi_or_spn
        echo "Enable Microsoft Entra integration and Azure RBAC for Kubernetes Authorization? Enter (y, n)"
        read "enable_aad_rbac"

        if [[ "$msi_or_spn" == "msi" ]]; then
            msi_or_spn="--tags ManagedCluster:PhilipMelloScriptAutomation"
        elif [[ "$msi_or_spn" == "spn" ]]; then
            msi_or_spn="--service-principal --tags ServicePrincipal:PhilipMelloScriptAutomation"
        else
            echo "Invalid input. Please enter MSI or SPN."
        fi

        if [[ $enable_aad_rbac =~ "[Yy]" ]]; then
            enable_aad_rbac="--enable-aad --enable-azure-rbac"
        elif [[ $enable_aad_rbac == "[Nn]" ]]; then
            enable_aad_rbac=""
        else
            echo "Invalid input."
        fi

        echo -e "
        +-------------------------------------------------------------------------+
        |${MAGENTA}AKS Creating${ENDCOLOR}
        +-------------------------------------------------------------------------+
        "  
        az aks create --resource-group $resource_group --name $cluster_name --location $location --node-count $node_count --network-plugin $network_plugin --tier $tier --os-sku $os_sku --node-vm-size $node_vm_size $msi_or_spn $enable_aad_rbac
        echo -e "
        +-------------------------------------------------------------------------+
        |${GREEN}AKS Created${ENDCOLOR}
        |Resource Group: $resource_group || Cluster Name: $cluster_name
        +-------------------------------------------------------------------------+
        |$(aks_get_url)
        +-------------------------------------------------------------------------+
        "  
        az aks get-credentials --resource-group $resource_group --name $cluster_name --overwrite-existing
        ;;
    *)
        echo "Invalid choice. Please select 1, 2 or 3."
        ;;
    esac
}

function aks_delete() {
    # Delete AKS cluster
    echo "Enter Resource Group:"
    read resource_group
    echo "Enter Cluster Name:"
    read cluster_name

    echo -e "
    +-------------------------------------------------------------------------+
    |${RED}Deleting AKS${ENDCOLOR}
    +-------------------------------------------------------------------------+
    "
    az aks delete --resource-group $resource_group --name $cluster_name
}

function check_cluster_status() {
    # Check if cluster is: Stopped, Faieled, Succeeded, K8S Version
    k8s_version=$(az aks show --resource-group $resource_group --name $cluster_name --query currentKubernetesVersion -o tsv)
    power_state=$(az aks show --resource-group $resource_group --name $cluster_name  --query powerState -o tsv)
    provisioning_state=$(az aks show --resource-group $resource_group --name $cluster_name --query provisioningState -o tsv)
    echo "Cluster Status: $k8s_version
    |Power State: $power_state
    |Provisioning State: $provisioning_state"
}

function check_credentials_status() {
    # Check cluster credentials
    credentials_status=$(az aks show --resource-group $resource_group --name $cluster_name --query servicePrincipalProfile.clientId -o tsv)
    credentials_endtime=$(az ad app credential list --id $credentials_status --query "[].endDateTime" -o tsv)
    echo "$credentials_status"
    echo "$credentials_list"
}

function reset_spn_credentials() {
    echo "Enter Resource Group:"
    read resource_group
    echo "Enter Cluster Name:"
    read cluster_name

    echo -e "
    +---------------------------------------------+
    |${RED}Status: Updating Service Principal Name (SPN)${ENDCOLOR}|
    +---------------------------------------------+
    "

    # Reset Service Princial Credentials (SPN)
    SP_ID=$(az aks show --resource-group $resource_group --name $cluster_name --query servicePrincipalProfile.clientId -o tsv)
    SP_SECRET=$(az ad app credential reset --id "$SP_ID" --query password -o tsv)
    SP_UPDATE=$(az aks update-credentials --resource-group $resource_group --name $cluster_name --reset-service-principal --service-principal "$SP_ID" --client-secret "${SP_SECRET}")
    eval $SP_UPDATE

    keyId=$(az ad app credential list --id $SP_ID --query [].keyId -o tsv)

    echo -e "
    +--------------------------------------------+
    |${GREEN}Status: Service Principal Name (SPN) Updated${ENDCOLOR}|
    +---------------------------------------------------------+
    |App Registrations: $SP_ID  |
    |Secret Password $SP_SECRET |
    |Secret ID: $keyId          |
    +---------------------------------------------------------+
    "
}

function check_pdb() {
    # Check if the AKS cluster has a PDB
    echo -e "Microsoft Official documentation:
    'https://learn.microsoft.com/en-us/troubleshoot/azure/azure-kubernetes/error-code-poddrainfailure#symptoms'
    "
    pdbCount=$(kubectl get pdb --all-namespaces | wc -l)
    pdbCount2=$(kubectl get pdb --all-namespaces | grep "0")
    command="kubectl get pdb --all-namespaces"
    pattern="0"
    output=$($command | grep "$pattern")

    if echo "$output" | grep -q "0"; then
        echo -e "
        AKS cluster has $pdbCount PDBs and PDB:
        |${RED}$pdbCount2${ENDCOLOR}|
        is not allowing for disruption, 
        warning: this may not allow the node to be drained and therefore blocking an upgrade process.
        "
    else
        echo -e "${GREEN}|The AKS cluster does not have a Pod Disruption Budget.${ENDCOLOR}|"
    fi
}

function backup_pdb() {
    # Set your output file name here
    OUTPUT_FILE="pdb_backup.yaml"

    # Get all PDBs in all namespaces
    kubectl get pdb --all-namespaces -o json > $OUTPUT_FILE
    echo "All PDBs have been backed up to $OUTPUT_FILE."
}

function check_memory_pressure() {
    # Check for memory pressure
    MEMORY_PRESSURE=$(kubectl describe nodes | grep "MemoryPressure")
    if [[ $MEMORY_PRESSURE == *"True"* ]]; then
        echo -e "${RED}|The cluster has memory pressure${ENDCOLOR}|"
    else
        echo -e "${GREEN}|The cluster DOES NOT have memory pressure${ENDCOLOR}|"
    fi
}

function check_disk_pid_status() {
    # Check for PID pressure
    PID_PRESSURE=$(kubectl describe nodes | grep "PIDPressure")
    if [[ $PID_PRESSURE == *"True"* ]]; then
        echo -e "${RED}|The cluster has PID pressure${ENDCOLOR}|"
    else
        echo -e "${GREEN}|The cluster DOES NOT have PID pressure${ENDCOLOR}|"
    fi
}

function check_disk_pressure_status() {
    # Check for disk pressure
    DISK_PRESSURE=$(kubectl describe nodes | grep "DiskPressure")
    if [[ $DISK_PRESSURE == *"True"* ]]; then
        echo -e "${RED}|The cluster has disk pressure${ENDCOLOR}|"
    else
        echo -e "${GREEN}|The cluster DOES NOT have disk pressure${ENDCOLOR}|"
    fi
}

function check_acr_connection() {
    # Check ACR connection issues
    az acr list -o table
    echo "Enter ACR Name"
    read acr_link
    acr_token=$(az account get-access-token -o tsv --query=accessToken)
    curl -H "Authorization: Bearer $acr_token"  https://$acr_link.azurecr.io/oauth2/exchange
}

function aks_get_url() {
    # Get AKS URL Azure Portal
    aks_azure_link=$(az aks browse --resource-group $resource_group --name $cluster_name)
    echo "Microsoft Official documentation: 
    |'https://learn.microsoft.com/pt-pt/cli/azure/aks?view=azure-cli-latest#az-aks-browse'
    +-------------------------------------------------------------------------+
    |Go to Azure Portal to start your AKS:
    |$aks_azure_link
    "
}

function aks_get_top_nodes() {
    # Get top nodes by memory
    kubectl top nodes --sort-by=memory
}

function aks_get_top_pods() {
    # Get top pods by memory
    kubectl top pods --sort-by=memory -A
}

function aks_describe_nodes() {
    # Describe nodes
    echo ""
}

function aks_check_top() {
    # Get Pod, Node Logs
    kubectl top nodes --sort-by=memory
    kubectl top pods --sort-by=memory -A
    folderlogs=aks-top-logs
    mkdir $folderlogs
    kubectl top nodes --sort-by=memory > $folderlogs/topNodes.txt
    kubectl top pods --sort-by=memory -A > $folderlogs/topPods.txt
    zip -r aks-top-logs.zip $folderlogs
    echo "Logs has been saved in $folderlogs and zip file: aks-top-logs.zip"

}

function aks_tcpdump() {
    # Get tcpdump
    echo -e "Documentation
    'https://github.com/josecaneira/aks-lab/tree/main/tcpdump_daemonset'
    "

    echo -e "
    +-------------------------------------------------------------------------+
    |A PV/PVC file share will be created on the AKS cluster default storage account 
    |that then can be browsed on your cluster managed Resource Group "MC_" using Azure Portal. 
    |If no default storage account exists a new one will be created, 
    |please remember to delete it after it no longer being required.
    |
    +-------------------------------------------------------------------------+"
    kubectl apply -f https://github.com/josecaneira/aks-lab/raw/main/tcpdump_daemonset/tcpdump_ds.yaml
    kubectl get pv|grep tcpdump

}

function aks_get_syslog() {
    # Get SysLog
    kubectl get nodes
    echo "Enter node name"
    read node_name
    kubectl debug node/$node_name --image=nginx
	kubectl get pods
    echo "Enter pods name"
    read pod_name
	kubectl cp $pod_name:/host/var/log/ /tmp/log
	zip -r syslog.zip /tmp/log
    echo "Logs has been saved in syslog.zip in the current folder"

}

function aks_get_configmap() {
    # Get Configmap
    kubectl get configmap -A
}

function az_aks_information() {
    # AKS Information
    echo "1. Check Policies"
    echo "Enter your option:"
    read option

    case $option in
        1)
            echo "1. Check Policies by Resource Group"
            echo "2. Check Policies by Subscription"
            echo "Enter your option:"
            read option
            if [[ $option == "1" ]]; then
                echo "Enter Resource Group:"
                read resource_group
                az policy assignment list --resource-group $resource_group
            elif [[ $option == "2" ]]; then
                echo "Enter Subscription:"
                read subscription_id
                az policy assignment list --subscription $subscription_id
            else
                echo "Invalid option"
            fi
            ;;
        *)
            echo "Invalid choice."
            ;;
    esac
    #az aks show --resource-group $resource_group --name $cluster_name --query linuxProfile.adminUsername -o tsv
    #az aks show --resource-group $resource_group --name $cluster_name --query linuxProfile.ssh.publicKeys[0].keyData -o tsv
    #az aks show --resource-group $resource_group --name $cluster_name --query location -o tsv
    #az aks show --resource-group $resource_group --name $cluster_name --query sku.tier -o tsv
    #az aks show --resource-group $resource_group --name $cluster_name --query nodeProvisioningProfile -o tsv
}

function aks_nodepool_information() {
    # Nodepoool information
    echo -e "Microsoft Official Documentation: 
    'https://learn.microsoft.com/en-US/cli/azure/aks/nodepool?view=azure-cli-latest#az_aks_nodepool_list'
    "
    az aks nodepool list $resource_group --name $cluster_name -o wide
}

function aks_update_upgrade() {
    # Update OR Upgrade
    echo "1. Upgrade AKS"
    echo "2. Upgrade Nodepool"
    echo "Enter your option:"
    read option

    case $option in
    1)
        echo "Enter Resource Group:"
        read resource_group
        echo "Enter Cluster Name:"
        read cluster_name
        echo "Enter your desired Kubernetes Version | Ex: 1.27.9, 1.28.3, 1.28.5"
        read k8s_version
        az aks upgrade --resource-group $resource_group --name $cluster_name --kubernetes-version $k8s_version
        ;;
    2)
        echo "Enter Resource Group:"
        read resource_group
        echo "Enter Cluster Name:"
        read cluster_name
        echo "Enter your Nodepool Name"
        read nodepool_name
        echo "Enter your desired Kubernetes Version | Ex: 1.27.9, 1.28.3, 1.28.5"
        read k8s_version
        az aks nodepool upgrade --resource-group $resource_group --cluster-name $cluster_name --name $nodepool_name --kubernetes-version $k8s_version
        ;;
    *)
        echo "Invalid choice. Please select 1 or 2."
        ;;

    esac
}

function aks_version_list_location() {
    # List AKS version by location
    az account list-locations -o table
    echo "Enter location"
    read location
    az aks get-versions --location $location --output table
}

function aks_get_pv_pvc() {
    # List all PV and PVC
    kubectl get pv
    kubectl get pvc
}

function aks_enable_disable_addon() {
    # AKS Enable or Disable Addons
    echo "1. Enable or Disable AKS Backup Extension"
    echo "2. Enable or Disable Monitoring logs"
    echo "3. Enable or Disable open-service-mesh addon"
    echo "Enter your option:"
    read option

    pause_function() {
    read -p "Press Enter to continue the installation..."
    }

    case $option in
    1)
        echo "Enable AKS Backup Extension"
        echo -e "Microsoft Official Documentation: 
        'https://learn.microsoft.com/en-us/azure/backup/azure-kubernetes-service-cluster-manage-backups'
        "
        echo "Choose Option: (1 = Enable / 2 = Disable / 3 = Troubleshoot)"
        read addons_option

        if [[ "$addons_option" == "1" ]]; then
        azurepolicy_check=$(kubectl get events -A | grep "azurepolicy-k8sazurev2containerallowedimag")
            if [[ $azurepolicy_check == *"azurepolicy-k8sazurev2containerallowedimag"* ]]; then
            echo -e "
            +-------------------------------------------------------------------------+
            |${RED}The policy:azurepolicy-k8sazurev2containerallowedimag
            |is affecting the AKS Backup Addon Installation${ENDCOLOR}
            +-------------------------------------------------------------------------+
            "
            exit 1
            fi
            echo "Enable AKS Backup Extension"
            echo "Enter Resource Group:"
            read resource_group
            echo "Enter Cluster Name:"
            read cluster_name
            echo "Storage Account Name"
            read storageaccount_name
            echo "Blob Container Name"
            read blobcontainer_name
            echo "Storage Account Resource Group Name"
            read storageaccount_resource_group_name
            echo "Storage Account Subscription Id"
            read storageaccountsubscriptionid
            echo -e "
            +-------------------------------------------------------------------------+
            |${MAGENTA}Enabling AKS Backup Extension${ENDCOLOR}
            +-------------------------------------------------------------------------+
            "
            echo -e " ${YELLOW}
            The registration may take up to 10 minutes. To monitor the registration process, wait the status to show:
            Registered.${ENDCOLOR}"
            kubectl config set-context --current --namespace=default
            az provider register --namespace Microsoft.KubernetesConfiguration
            watch -g az provider show -n Microsoft.KubernetesConfiguration -o table
            pause_function
            az extension add --name aks-preview
            az extension update --name aks-preview
            echo -e "It takes a few minutes for the status to show Registered."
            az feature register --namespace "Microsoft.ContainerService" --name "TrustedAccessPreview"
            watch -g az feature show --namespace "Microsoft.ContainerService" --name "TrustedAccessPreview"
            pause_function
            az provider register --namespace Microsoft.ContainerService
            az k8s-extension create --name azure-aks-backup --extension-type microsoft.dataprotection.kubernetes --scope cluster --cluster-type managedClusters --cluster-name $cluster_name --resource-group $resource_group --release-train stable --configuration-settings blobContainer=$blobcontainer_name storageAccount=$storageaccount_name storageAccountResourceGroup=$storageaccount_resource_group_name storageAccountSubscriptionId=$storageaccountsubscriptionid
        elif [[ "$addons_option" == "2" ]]; then
            echo "Disable AKS Backup Extension"
            echo "Disable AKS Backup Extension"
            echo "Enter Resource Group:"
            read resource_group
            echo "Enter Cluster Name:"
            read cluster_name

            echo -e "
            +-------------------------------------------------------------------------+
            |${RED}Disabling AKS Backup Extension${ENDCOLOR}
            +-------------------------------------------------------------------------+
            "
            az k8s-extension delete --resource-group $resource_group --cluster-name $cluster_name --cluster-type managedClusters --name azure-aks-backup
        elif [[ "$addons_option" == "3" ]]; then
        echo  -e "
        Troubleshoot Azure Kubernetes Service backup and restore
        Microsoft Official Documentation:
        'https://learn.microsoft.com/en-us/azure/backup/azure-kubernetes-service-backup-troubleshoot'

        Scenario 1
        Error message:
        ${RED}{Helm installation from path [] for release [azure-aks-backup] failed with the following error: err [release azure-aks-backup failed, and has been uninstalled due to atomic being set: failed post-install: timed out waiting for the condition]} occurred while doing the operation: {Installing the extension} on the config${ENDCOLOR}
        
        Cause: The extension has been installed successfully, but the pods aren't spawning. 
        This happens because the required compute and memory aren't available for the pods.

        Resolution: To resolve the issue, increase the number of nodes in the cluster. 
        This allows sufficient compute and memory to be available for the pods to spawn. 
        To scale node pool on Azure portal, follow these steps:
            ${GREEN}
            1.On the Azure portal, open the AKS cluster.
            2.Go to Node pools under Settings.
            3.Select Scale node pool, and then update the minimum and maximum values on the Node count range.
            4.Select Apply.
            5.AKS Backup Extension installation error resolutions
            ${ENDCOLOR}

        ---
        Scenario 4
        Error message:
        ${RED}dataprotection-microsoft 1s Warning FailedCreate job/dataprotection-microsoft-kubernetes-agent-upgrade-crds Error creating: admission webhook "validation.gatekeeper.sh"
        denied the request: [azurepolicy-k8sazurev2containerallowedimag-xxxxxxxxxxxxxxxxxxxx] 
        Container image mcr.microsoft.com/azurebackup/k8s/velero:0.0.02574.247 for container velero has not been allowed....
        ${ENDCOLOR}

        Solution 1:
        Include “dataprotection-microsoft” into namespace exclusions:

        ["dataprotection-microsoft","kube-system","gatekeeper-system","azure-arc","azure-extensions-usage-system"]

        Go to: Home > Policy > Assignments > "FIND THE POLICY"

        ---

        Solution 2: Edit policy in Azure Portal.

        Go to: Home > Policy > Assignments > Kubernetes cluster containers should only use allowed images
        change to allow in: Parameters
        This policy can be found in:
        'https://learn.microsoft.com/en-us/azure/aks/policy-reference'

        1. To check logs of the *ExtensionAgent* pod, run the following command:
        kubectl get events -A
        "
        else
            echo "Incorret Option"
        fi
        ;;
    2)
        echo "Enable or Disable Monitoring logs"
        echo -e "Microsoft Official Documentation:
        'https://learn.microsoft.com/en-us/azure/azure-monitor/containers/kubernetes-monitoring-enable'
        'https://learn.microsoft.com/en-us/azure/azure-monitor/containers/kubernetes-monitoring-disable'
        "
        echo "Choose Option: (1 = Enable / 2 = Disable)"
        read addons_option
        echo "Enter Resource Group:"
        read resource_group
        echo "Enter Cluster Name:"
        read cluster_name

        if [[ "$addons_option" == "1" ]]; then
            echo -e "
            +-------------------------------------------------------------------------+
            |${MAGENTA}Enabling AKS Monitoring Logs${ENDCOLOR}
            +-------------------------------------------------------------------------+
            "
            az aks enable-addons -a monitoring --resource-group $resource_group --name $cluster_name
        elif [[ "$addons_option" == "2" ]]; then
            echo -e "
            +-------------------------------------------------------------------------+
            |${RED}Disabling AKS Monitoring Logs${ENDCOLOR}
            +-------------------------------------------------------------------------+
            "
            az aks disable-addons -a monitoring --resource-group $resource_group --name $cluster_name
        else
            echo "Incorret Option"
        fi
        ;;
    3)
        echo "Enable or Disable open-service-mesh addon"
        echo -e "Microsoft Official documentation: 
        'https://learn.microsoft.com/en-us/cli/azure/aks?view=azure-cli-latest#az-aks-enable-addons(aks-preview)'
        "
        echo "Choose Option: (1 = Enable / 2 = Disable)"
        read addons_option
        echo "Enter Resource Group:"
        read resource_group
        echo "Enter Cluster Name:"
        read cluster_name
        if [[ "$addons_option" == "1" ]]; then
            echo -e "
            +-------------------------------------------------------------------------+
            |${MAGENTA}Enabling AKS open-service-mesh addon${ENDCOLOR}
            +-------------------------------------------------------------------------+
            "
            az aks enable-addons --resource-group $resource_group --name $cluster_name --addons open-service-mesh
        elif [[ "$addons_option" == "2" ]]; then
            echo -e "
            +-------------------------------------------------------------------------+
            |${RED}Disabling AKS open-service-mesh addon${ENDCOLOR}
            +-------------------------------------------------------------------------+
            "
            az aks disable-addons --resource-group $resource_group --name $cluster_name --addons open-service-mesh
        else
            echo "Incorret Option"
        fi
        ;;
    *)
        echo "Invalid choice. Please select 1 or 2."
        ;;
    esac
}

function az_cli_tools(){
    # Az Cli Tools
    echo "1. Install az-cli"
    echo "2. Install kubectl"
    echo "3. Install helm"
    read option
    case $option in
    1)
        echo -e "Microsoft Official Documentation: 
        'https://learn.microsoft.com/en-us/cli/azure/install-azure-cli-linux?pivots=apt'
        "
        echo -e "
        +-------------------------------------------------------------------------+
        |${MAGENTA}Installing az-cli${ENDCOLOR}
        +-------------------------------------------------------------------------+
        "
        curl -sL https://aka.ms/InstallAzureCLIDeb | sudo bash
        echo -e "
        +-------------------------------------------------------------------------+
        |${GREEN}az-cli Installed${ENDCOLOR}
        +-------------------------------------------------------------------------+
        "
        ;;
    2)
        echo -e "Microsoft Official Documentation: 
        'https://learn.microsoft.com/en-us/cli/azure/aks?view=azure-cli-latest#az-aks-install-cli'
        "
        echo -e "
        +-------------------------------------------------------------------------+
        |${MAGENTA}Installing kubectl${ENDCOLOR}
        +-------------------------------------------------------------------------+
        "
        az aks install-cli
        echo -e "
        +-------------------------------------------------------------------------+
        |${GREEN}kubectl Installed${ENDCOLOR}
        +-------------------------------------------------------------------------+
        "
        ;;
    3)
        echo -e "Helm Official Documentation: 
        'https://helm.sh/docs/intro/install/'
        'https://github.com/helm/helm/releases'
        "
        echo "Install helm"
        echo -e "
        +-------------------------------------------------------------------------+
        |${MAGENTA}Installing helm${ENDCOLOR}
        +-------------------------------------------------------------------------+
        "
        wget https://get.helm.sh/helm-v3.14.3-linux-amd64.tar.gz
        tar -zxvf helm-v3.14.3-linux-amd64.tar.gz
        sudo mv linux-amd64/helm /usr/local/bin/helm
        echo -e "
        +-------------------------------------------------------------------------+
        |${GREEN}helm Installed${ENDCOLOR}
        +-------------------------------------------------------------------------+
        "
        ;;
    *)
         echo "Invalid choice. Please select 1, 2 or 3."
        ;;
    esac
}

function az_vmss() {
    echo "1. vmss delete-instances"
    echo "2. vmss deallocate"
    echo "Enter your option:"
    read option
    echo -e "
    Microsoft Official Documentation: 
    'https://learn.microsoft.com/en-us/cli/azure/vmss?view=azure-cli-latest#commands'
    "
    case $option in
    1)
        echo "Az vmss delete-instances"
        echo "Enter MC_Resource Group:"
        read resource_group
        echo "Enter Cluster Name:"
        read cluster_name
        echo "Enter VMSS ScaleSet Name"
        read vmss_scaleset
        echo "Enter VMSS ID"
        read vmss_id
        az vmss delete-instances --instance-ids $vmss_id --name $vmss_scaleset --resource-group $resource_group --no-wait
        ;;
    2)
        echo "Az vmss deallocate"
        echo "Enter MC_Resource Group:"
        read resource_group
        echo "Enter Cluster Name:"
        read cluster_name
        echo "Enter VMSS ScaleSet Name"
        read vmss_scaleset
        echo "Enter VMSS ID"
        read vmss_id
        az vmss deallocate --instance-ids $vmss_id --name $vmss_scaleset --resource-group $resource_group
        ;;
    *)
         echo "Invalid choice. Please select 1 or 2."
        ;;
    esac
}

function az_aks_addon_check() {
    # Check AKS Addons Installed
    az_aks_addon_check_cmd=$(az aks addon list --resource-group $resource_group --name $cluster_name -o table)
    echo "$az_aks_addon_check_cmd"
}

function cluster_analysis() {
    # AKS Cluster Analysis
    echo "Enter Resource Group:"
    read resource_group
    echo "Enter Cluster Name:"
    read cluster_name

    echo -e "
    +-----------------------+
    |${MAGENTA}Analysing Cluster...${ENDCOLOR}   |
    +-----------------------+
    "
    
function cluster_on_off() {
    power_state=$(az aks show --resource-group $resource_group --name $cluster_name --query powerState -o tsv)
    if [[ "$power_state" != "Stopped" ]]; then
    echo -e "
    +-------------------------------------------------------------------------+
    |${GREEN}AKS Analysis${ENDCOLOR}
    |Resource Group: $resource_group || Cluster Name: $cluster_name
    +-------------------------------------------------------------------------+
    |$(aks_get_url)
    +-------------------------------------------------------------------------+        
    |$(check_cluster_status)
    |$(check_memory_pressure)
    |$(check_disk_pressure_status)
    |$(check_disk_pid_status)
    +---------------------------------------------------------+
    |$(check_pdb)
    +---------------------------------------------------------+
    |NODES:
    |$(aks_get_top_nodes)
    +---------------------------------------------------------+
    |PODS:
    |$(aks_get_top_pods)
    +---------------------------------------------------------+
    |Configmap:
    |$(aks_get_configmap)
    +---------------------------------------------------------+
    |ADDONS:
    |$(az_aks_addon_check)
    "
    else
        echo -e "
    +-------------------------------------------------------------------------+
    |${GREEN}AKS Analysis${ENDCOLOR}
    |${RED}Start your cluster to analyze in more detail${ENDCOLOR}
    |Resource Group: $resource_group || Cluster Name: $cluster_name
    +-------------------------------------------------------------------------+       
    |$(check_cluster_status)
    +-------------------------------------------------------------------------+
    |Run: az aks start --resource-group $resource_group --name $cluster_name
    +-------------------------------------------------------------------------+
    |$(aks_get_url)
    +-------------------------------------------------------------------------+
    "
    fi
    }
    cluster_on_off
}

# ---

# Manual
manual() {
    echo -e "Get AKS Credentials: 'https://docs.microsoft.com/en-US/cli/azure/aks#az_aks_get_credentials'"
    echo -e "
    'https://learn.microsoft.com/en-us/cli/azure/vmss?view=azure-cli-latest#commands'
    "

exit 0
}

if [[ $1 == "-h" || $1 == "--help" || "$1" == "--h" ]]; then
    manual
    exit 1
fi

echo "Choose an option:"
echo "1. Create or Delete Resource Group"
echo "2. Create AKS"
echo "3. Az Tools (Install az-cli OR kubectl)"
echo "4. Delete AKS"
echo "5. Reset Cluster Service Principal Credentials (SPN)"
echo "6. Backup Pod Disruption Budget (PDB)"
echo "7. Check ACR Connection"
echo "8. Check Top (Pods and Nodes)"
echo "9. Get TCPDUMP"
echo "10. Get SysLog"
echo "11. Get AKS Versions by location"
echo "12. Upgrade AKS or Nodepool"
echo "13. AKS Enable or Disable Addons"
echo "14. Az vmss"
echo "15. Information"
echo "99. Cluster Analysis (Top Nodes, Top Pods, MSI, SPN, PDB, PowerState, Credentials, AKS URL...)"
read option

case $option in
    1)
        az_resource_group
        ;;
    2)  
        aks_create
        ;;
    3)
        az_cli_tools
        ;;
    4)
        aks_delete
        ;;
    5)
        reset_spn_credentials
        ;;
    6)
        backup_pdb
        ;;
    7)
        check_acr_connection
        ;;
    8) 
        aks_check_top
        ;;
    9)
        aks_tcpdump
        ;;
    10) 
        aks_get_syslog
        ;;
    11)
        aks_version_list_location
        ;;
    12) 
        aks_update_upgrade
        ;;
    13)
        aks_enable_disable_addon
        ;;
    14)
        az_vmss
        ;;
    15)
        az_aks_information
        ;;
    99)
        cluster_analysis
        ;;
    *)
        echo "Invalid option"
        ;;
esac
